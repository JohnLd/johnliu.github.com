---
layout : post 
category : Android
tags : [Android,Handler]
desc : Handler详解

title : Handler详解
---

##定义：
Handler允许你发送和处理Message。当创建一个Handler，它会关联当前线程的Looper

##Handler发送和处理Message:
![image](http://liuguangqiang.com/img/handler.png)

当调用Handler的方法sendMessage()的时候，一个Message对象将会被插入和Handler相关联的MessageQueue中。而每一Handler在创建的时候，都会创建一个Looper，其方法loop()会不停的从MessageQueue中取出Message,并调用Handler的方法dispatchMessage来分发Message,最后调用回调函数handleMessage,这里就已经回到到来UI线程,handleMessage是一个空的方法，所以需要自己重写。

//发送Message
{% highlight java  %}
	
public final boolean sendMessage(Message msg)
{
   return sendMessageDelayed(msg, 0);
}  
    
{% endhighlight %}

//把Message加入到MessageQueue
{% highlight java  %}

    public final boolean sendMessageAtFrontOfQueue(Message msg) {
        MessageQueue queue = mQueue;
        if (queue == null) {
            RuntimeException e = new RuntimeException(
                this + " sendMessageAtTime() called with no mQueue");
            Log.w("Looper", e.getMessage(), e);
            return false;
        }
        return enqueueMessage(queue, msg, 0);
    }

{% endhighlight %}

{% highlight java  %}

    private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) {
        msg.target = this;
        if (mAsynchronous) {
            msg.setAsynchronous(true);
        }
        return queue.enqueueMessage(msg, uptimeMillis);
    }

{% endhighlight %}


//调用loop()，获取Message对象，如果Meesage不为空，就调用和其相关的Handler的方法dispatchMessage()
{% highlight java  %}

    public static void loop() {
        final Looper me = myLooper();
        if (me == null) {
            throw new RuntimeException("No Looper; Looper.prepare() wasn't called on this thread.");
        }
        final MessageQueue queue = me.mQueue;
        
      	......
      	
        for (;;) {
            Message msg = queue.next(); // might block
            if (msg == null) {
                // No message indicates that the message queue is quitting.
                return;
            }

            // This must be in a local variable, in case a UI event sets the logger
            Printer logging = me.mLogging;
            if (logging != null) {
                logging.println(">>>>> Dispatching to " + msg.target + " " +
                        msg.callback + ": " + msg.what);
            }

            msg.target.dispatchMessage(msg);

           ......
           
            msg.recycle();
        }
    }

{% endhighlight %}

//dispatchMessage
{% highlight java  %}

    public void dispatchMessage(Message msg) {
        if (msg.callback != null) {
            handleCallback(msg);
        } else {
            if (mCallback != null) {
                if (mCallback.handleMessage(msg)) {
                    return;
                }
            }
            handleMessage(msg);
        }
    }

{% endhighlight %}
